---
title: "HW_2"
author: "Glebus Alexandr"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(ggfortify)
library(sandwich)
library(lmtest)
library(modelsummary)
```


## Загрузка данных

Загрузим данные, выберем нужные, сделаем EDA

```{r}
cataract <- read.csv('congenital_cataract.csv', ) %>% 
  select(-X) %>% 
  mutate(id = as.numeric(id),
       age_flwp = as.numeric(age_flwp),
       strat = as.factor(strat),
       side = as.factor(side),
       glau = as.factor(glau),
       bcdva = as.numeric(bcdva),
       bcnva = as.numeric(bcnva))
cataract %>% summary()
```

```{r}
# График для остроты зрения вдали (bcdva)
ggplot(cataract, aes(x = age_flwp, y = bcdva, color = strat)) +
  geom_point() +
  geom_smooth(method = lm) +
  labs(title = "График зависимости остроты зрения вдали от возраста",
       x = "Возраст во время фоллоу-апа (года)",
       y = "Острота зрения вдали",
       color = "Стратегия лечения") +
  theme_minimal()

# График для остроты зрения вблизи (bcnva)
ggplot(cataract, aes(x = age_flwp, y = bcnva, color = strat)) +
  geom_point() +
  geom_smooth(method = lm) +
  labs(title = "График зависимости остроты зрения вблизи от возраста",
       x = "Возраст во время фоллоу-апа (года)",
       y = "Острота зрения вблизи",
       color = "Стратегия лечения") +
  theme_minimal()
```

```{r}
# График для остроты зрения вдали (bcdva)
ggplot(cataract) +
  geom_density(aes(x = bcdva, fill = strat), alpha = 0.5) +
  labs(title = "Плотность распределения остроты зрения вдали",
       x = "Острота зрения вдали",
       y = "Плотность") +
  theme_minimal()

# График для остроты зрения вблизи (bcnva)
ggplot(cataract) +
  geom_density(aes(x = bcnva, fill = strat), alpha = 0.5) +
  labs(title = "Плотность распределения остроты зрения вблизи",
       x = "Острота зрения вблизи",
       y = "Плотность") +
  theme_minimal()
```

Разделим остротe зрения вдали на две области (острота зрения < 0.4 и острота зрения > 0.4). 
В группе низкого зрения худшим зрением обладают пациенты с афакией на основе визуальной оценки. 
А в группе высокого зрения на основе визуальной оценки не видно преобладания какой либо стратегии.
Рассмотрим график отстроты зрения вблизи. Не видно преобладания какой либо стратегии.
Распределение остроты зрения и для Афакии и для Артефакии ненормальное. Возможно, стоит это учесть при построении моделей.

## 1. Какая стратегия предпочтительна для лечения врожденной катаракты, с точки зрения остроты зрения? Не используйте информацию о наличии глаукомы при ответе на этот вопрос.

### 1.1. Оцените эффект стратегии без коррекции на ковариаты.

```{r}
fit1 <- lm(bcdva ~ strat, data = cataract)
fit2 <- lm(bcnva ~ strat, data = cataract)
# Визуализируем
modelsummary(
  list(fit1, fit2), statistic = "{p.value} [{conf.low}, {conf.high}]")
```

Модели без учета возраста, наличия глаукомы, стороны, на которой была проведена операция не показывают значимых связей стратегий лечения с остротой зрения.

### 1.2. Оцените эффект стратегии с коррекцией на ковариаты. Обоснуйте необходимость включения каждой ковариаты в вашу модель.

Включим в модель переменные отвечающие за стратегию, возраст и сторону, на который была проведена операция, потому что они могут повлиять на эффективность терапии. Фактор глаукомы не включен по условию. Острота зрения вблизи и вдали ассоциированы, поэтому не будем одновременно включать их в модель.

```{r}
fit1 <- lm(bcnva ~ strat + age_flwp + side, data = cataract)
fit2 <- lm(bcdva ~ strat + age_flwp + side, data = cataract)
modelsummary(
  list(fit1, fit2), statistic = "{p.value} [{conf.low}, {conf.high}]")
```
Оценим распределение остатков

```{r}
autoplot(fit1)
autoplot(fit2)
```

Наблюдается небольшое отклонение он нормальности остатков регрессии, гетероскедастичность. Кластеризации остатков не наблюдается.

Проведем коррекцию на гетероскедастичность.

```{r}
robust_fit1 <- coeftest(fit1, vcov = vcovHC, type = "HC4")
robust_fit2 <- coeftest(fit2, vcov = vcovHC, type = "HC4")
modelsummary(
  list(robust_fit1, robust_fit2), statistic = "{p.value} [{conf.low}, {conf.high}]")
```

Если выбрана стратегия Артефакия, то среднее значение острота зрения вдали увеличится на примерно 0.1016 по сравнению с Афакия (p = 0.043) при прочих равных обстоятельствах.  Для остроты зрения вблизи статистической разницы не обнаружено.

##  2. Какой эффект оказывает глаукома на остроту зрения? Зависит ли этот эффект от выбранной стратегии? Опишите эффект от терапии с учетом потенциального развития глаукомы. Какая терапия предпочтительнее с учетом потенциального развития глаукомы?

### 2.1. Оцените эффект без коррекции на ковариаты.

Модель без ковариат.

```{r}
fit1 <- lm(bcdva ~ glau, data = cataract)
fit2 <- lm(bcnva ~ glau, data = cataract)
# Визуализируем
modelsummary(
  list(fit1, fit2), statistic = "{p.value} [{conf.low}, {conf.high}]")
```

Влияние глаукомы на остроту зрения может быть слабо отрицательным, однако результ не является статистически значимым.

Добавим пересечение фактора глаукоы и фактора стратегии, потому что наличие глаукомы может по разному влиять на остроту зрения, в зависимости от выбранной стратегии.

```{r}
fit1 <- lm(bcdva ~ glau * strat, data = cataract)
fit2 <- lm(bcnva ~ glau * strat, data = cataract)
modelsummary(
  list(fit1, fit2), statistic = "{p.value} [{conf.low}, {conf.high}]")
```

Мы не можем судить о превосходстве одной терапии над другой.

### 2.2. Оцените эффект с коррекцией на ковариаты. Обоснуйте необходимость включения каждой ковариаты в вашу модель.

Добавим ковариаты: возраст и сторона, на которой была проведена операция, так как они могут влиять на результат терапии.

```{r}
fit1 <- lm(bcdva ~ strat * glau + age_flwp + side, data = cataract)
fit2 <- lm(bcnva ~ strat * glau + age_flwp + side, data = cataract)
modelsummary(
  list(fit1, fit2), statistic = "{p.value} [{conf.low}, {conf.high}]")
```
Оценим распределение регрессионных остатков
```{r}
autoplot(fit1)
autoplot(fit2)
```

Наблюдается небольшое отклонение он нормальности остатков регрессии, гетероскедастичность. Кластеризации остатков не наблюдается.
Проведем коррекцию на гетероскедастичность.

```{r}
fit1 <- lm(bcdva ~ strat * glau + age_flwp + side, data = cataract)
robust_fit1 <- coeftest(fit1, vcov = vcovHC, type = "HC4")
fit2 <- lm(bcnva ~ strat * glau + age_flwp + side, data = cataract)
robust_fit2 <- coeftest(fit2, vcov = vcovHC, type = "HC4")
modelsummary(
  list(robust_fit1, robust_fit2), statistic = "{p.value} [{conf.low}, {conf.high}]")
```


При использовании стратегии "Артефакия" может наблюдаться снижение зрения вблизи, но результаты не достигают статистической значимости на уровне 0.05. Это означает, что, хотя есть некоторые свидетельства в пользу влияния стратегии "Артефакия", нам нужны дополнительные данные, чтобы с уверенностью утверждать о значимом эффекте.

Взаимодействие между стратегией "Артефакия" и наличием глаукомы указывает на то, что эффект "Артефакии" может изменяться в зависимости от наличия глаукомы. Результаты не достигли статистической значимости. Врачам следует с осторожностью выбирать стратегию "Артефакия" к пациентам с потенциальным развитием глаукомы, потому что влияние глаукомы при стратегии "Артефакия" на остроту зрения может быть отрицательным.

## 3. Как связана частота развития глаукомы с выбранной стратегией?

### 3.1. Оцените эффект стратегии без коррекции на ковариаты.

Построим логистическую регрессию без ковариат.

```{r}
fit <- glm(glau ~  strat, data = cataract, family = binomial)
modelsummary(
  list(fit), statistic = "{p.value} [{conf.low}, {conf.high}]")
```
В целом, эти результаты позволяют сделать предварительные выводы о связи выбранной стратегии с развитием глаукомы. Однако, статистическая значимость пока не подтверждает наличие этой связи. 

### 3.2. Оцените эффект стратегии с коррекцией на ковариаты. Обоснуйте необходимость включения каждой ковариаты в вашу модель.

Добавим ковариаты. Остроту зрения добавлять не будем, чтобы избежать коллайдера.

```{r}
fit <- glm(glau ~ strat + age_flwp + side, data = cataract, family = binomial)
modelsummary(
  list(fit), statistic = "{p.value} [{conf.low}, {conf.high}]")
```

В целом, результаты показывают, что после коррекции на ковариаты эффект стратегии Артефакия остается отрицательным, но не является статистически значимым. При этом включение других ковариат также не приводит к статистически значимым результатам. 

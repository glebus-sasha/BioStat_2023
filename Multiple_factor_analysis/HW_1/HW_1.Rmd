---
title: "HW_1"
author: "Glebus Alexandr"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(ggplot2)
library(stats)
library(pairwiseCI)
library(ggpubr)
```


## Загрузка данных

Загрузим данные, выберем нужные, сделаем EDA

```{r}
soccer_general <- read.csv2('soccer.csv') %>% 
  select(-X, -Weight) %>% 
  mutate(Position = as.factor(Position),
         Nationality = as.factor(Nationality),
         Age = as.numeric(Age),
         Height = as.numeric(Height)) %>% 
  filter(Nationality %in% c('Spanish', 'Italian', 'German', 'English', 'Argentinian'))
soccer_general %>% glimpse()
```
```{r}
set.seed(1)
soccer_wrk <- soccer_general[sample(1:nrow(soccer_general), 150), ] %>% 
  mutate(Nationality = factor(Nationality))
```

## Построение доверительных интервалов

Чтобы построить доверительные интервалы для попарных разниц между средними, используем pairwiseCI.
Сначала сделаем без поправки Бонферони.
```{r}
grouped_data <- soccer_wrk %>% 
  group_by(Position)
result_wrk_none <- pairwiseCI(Height ~ Position, data=grouped_data, method="Param.diff",  var.equal=TRUE)
result_wrk_none
```

```{r, fig.width=10, fig.height=5}
# Преобразуем результат в удобный формат для ggplot
result_wrk_none_df <- data.frame(
  comparison = result_wrk_none$byout[[1]]$compnames,
  estimate = result_wrk_none$byout[[1]]$estimate,
  lower = result_wrk_none$byout[[1]]$lower,
  upper = result_wrk_none$byout[[1]]$upper,
  adjustment = "None",
  sample = "Work"
)

# Построим график
fig_wrk_none <- ggplot(result_wrk_none_df, aes(x = comparison, y = estimate, ymin = lower, ymax = upper)) +
  geom_point(position = position_dodge(width = 0.2)) +
  geom_errorbar(position = position_dodge(width = 0.2), width = 0.2) +
  labs(title = "Pairwise Differences in Mean Height by Position",
       x = "Comparison",
       y = "Difference in Mean Height") +
  coord_flip() +
  theme_minimal()
fig_wrk_none
```

А теперь то же самое с поправкой Бонферони (для этого установим $conf.level=1-0.05\div6$)

```{r}
grouped_data <- soccer_wrk %>% 
  group_by(Position)
result_wrk_adj <- pairwiseCI(Height ~ Position, data=grouped_data, method="Param.diff",  var.equal=TRUE, conf.level=1-0.05/6)
result_wrk_adj
```

```{r, fig.width=10, fig.height=5}
# Преобразуем результат в удобный формат для ggplot
result_wrk_adj_df <- data.frame(
  comparison = result_wrk_adj$byout[[1]]$compnames,
  estimate = result_wrk_adj$byout[[1]]$estimate,
  lower = result_wrk_adj$byout[[1]]$lower,
  upper = result_wrk_adj$byout[[1]]$upper,
  adjustment = "Bonferoni",
  sample = "Work"
)

# Построим график
fig_wrk_adj <- ggplot(result_wrk_adj_df, aes(x = comparison, y = estimate, ymin = lower, ymax = upper)) +
  geom_point(position = position_dodge(width = 0.2)) +
  geom_errorbar(position = position_dodge(width = 0.2), width = 0.2) +
  labs(title = "Pairwise Differences in Mean Height by Position",
       x = "Comparison",
       y = "Difference in Mean Height") +
  coord_flip() +
  theme_minimal()
fig_wrk_adj
```
Интервалы стали шире.

Построим комбинированные графики для генеральных данных и выборки. 

```{r, fig.width=10, fig.height=5, warning=FALSE}
grouped_data <- soccer_general %>% 
  group_by(Position)

# Вычисляем интервалы для нескорректированных и скорректированных значений
result_general_none <- pairwiseCI(Height ~ Position, data=grouped_data, method="Param.diff",  var.equal=TRUE)
result_general_adj <- pairwiseCI(Height ~ Position, data=grouped_data, method="Param.diff",  var.equal=TRUE, conf.level=1-0.05/6)

# Создаем данные для графика
result_general_none_df <- data.frame(
  comparison = result_general_none$byout[[1]]$compnames,
  estimate = result_general_none$byout[[1]]$estimate,
  lower = result_general_none$byout[[1]]$lower,
  upper = result_general_none$byout[[1]]$upper,
  adjustment = "None",
  sample = "General"
)

result_general_adj_df <- data.frame(
  comparison = result_general_adj$byout[[1]]$compnames,
  estimate = result_general_adj$byout[[1]]$estimate,
  lower = result_general_adj$byout[[1]]$lower,
  upper = result_general_adj$byout[[1]]$upper,
  adjustment = "Bonferroni",
  sample = "General"
)

# Объединяем данные
result_combined_none_df <- rbind(result_wrk_none_df, result_general_none_df)
result_combined_adj_df <- rbind(result_wrk_adj_df, result_general_adj_df)

# Построение графика
fig_combined_none <- ggplot(result_combined_none_df, aes(x = comparison, y = estimate, ymin = lower, ymax = upper, color = sample)) +
  geom_point(position = position_dodge(width = 0.2), size = 3) +
  geom_errorbar(position = position_dodge(width = 0.2), width = 0.2, size = 1) +
  labs(title = "Pairwise Differences in Mean Height by Position",
       x = "Comparison",
       y = "Difference in Mean Height",
       color = "Sample") +
  coord_flip() +
  theme_minimal()

fig_combined_adj <- ggplot(result_combined_adj_df, aes(x = comparison, y = estimate, ymin = lower, ymax = upper, color = sample)) +
  geom_point(position = position_dodge(width = 0.2), size = 3) +
  geom_errorbar(position = position_dodge(width = 0.2), width = 0.2, size = 1) +
  labs(title = "Pairwise Differences in Mean Height by Position with Bonferoni",
       x = "Comparison",
       y = "Difference in Mean Height",
       color = "Sample") +
  coord_flip() +
  theme_minimal()

fig_combined_none
fig_combined_adj
```

Видно, что без в обоих случаях интервалы не всегда покрывают реальную разницу средних. С поправкой Бонферони, ситуация несколько лучше.


## Попарные тесты
Без поправки
```{r, fig.width=6, fig.height=5}
t_res_wrk_none <- pairwise.t.test(soccer_wrk$Height, soccer_wrk$Position, pool.sd = FALSE, p.adjust.method = 'none')
t_res_wrk_none

# Создаем данные для графика
comparison_data <- data.frame(
  Position1 = c("Forward", "Goalkeeper", "Goalkeeper", "Midfielder"),
  Position2 = c("Defender", "Forward", "Midfielder", "Forward"),
  P_Value = c(t_res_wrk_none$p.value[2, 1], t_res_wrk_none$p.value[3, 1], t_res_wrk_none$p.value[3, 2], t_res_wrk_none$p.value[3, 3])
)

# Построение графика
ggplot(comparison_data, aes(x = Position1, y = Position2, fill = P_Value)) +
  geom_tile() +
  geom_text(aes(label = sprintf("%.4f", P_Value)), vjust = 1) +
  scale_fill_gradient(low = "green", high = "red") +
  labs(title = "Pairwise Comparisons of Positions",
       x = "Position 1",
       y = "Position 2",
       fill = "P Value") +
  theme_minimal()
```



С поправкой Холма

```{r, fig.width=6, fig.height=5}
t_res_wrk_holm <- pairwise.t.test(soccer_wrk$Height, soccer_wrk$Position, pool.sd = FALSE)
t_res_wrk_holm

# Создаем данные для графика
comparison_data <- data.frame(
  Position1 = c("Forward", "Goalkeeper", "Goalkeeper", "Midfielder"),
  Position2 = c("Defender", "Forward", "Midfielder", "Forward"),
  P_Value = c(t_res_wrk_holm$p.value[2, 1], t_res_wrk_holm$p.value[3, 1], t_res_wrk_holm$p.value[3, 2], t_res_wrk_holm$p.value[3, 3])
)

# Построение графика
ggplot(comparison_data, aes(x = Position1, y = Position2, fill = P_Value)) +
  geom_tile() +
  geom_text(aes(label = sprintf("%.4f", P_Value)), vjust = 1) +
  scale_fill_gradient(low = "green", high = "red") +
  labs(title = "Pairwise Comparisons of Positions",
       x = "Position 1",
       y = "Position 2",
       fill = "P Value") +
  theme_minimal()

```


С поправкой Бенджамини-Хохберга

```{r, fig.width=6, fig.height=5}
t_res_wrk_BH <- pairwise.t.test(soccer_wrk$Height, soccer_wrk$Position, pool.sd = FALSE, p.adjust.method = 'BH')
t_res_wrk_BH

# Создаем данные для графика
comparison_data <- data.frame(
  Position1 = c("Forward", "Goalkeeper", "Goalkeeper", "Midfielder"),
  Position2 = c("Defender", "Forward", "Midfielder", "Forward"),
  P_Value = c(t_res_wrk_BH$p.value[2, 1], t_res_wrk_BH$p.value[3, 1], t_res_wrk_BH$p.value[3, 2], t_res_wrk_BH$p.value[3, 3])
)

# Построение графика
ggplot(comparison_data, aes(x = Position1, y = Position2, fill = P_Value)) +
  geom_tile() +
  geom_text(aes(label = sprintf("%.4f", P_Value)), vjust = 1) +
  scale_fill_gradient(low = "green", high = "red") +
  labs(title = "Pairwise Comparisons of Positions",
       x = "Position 1",
       y = "Position 2",
       fill = "P Value") +
  theme_minimal()
```

Создадим аналогичные графики для генеральных данных.

```{r, fig.width=6, fig.height=15}
t_res_wrk_none <- pairwise.t.test(soccer_general$Height, soccer_general$Position, pool.sd = FALSE, p.adjust.method = 'none')
t_res_wrk_holm <- pairwise.t.test(soccer_general$Height, soccer_general$Position, pool.sd = FALSE)
t_res_wrk_BH <- pairwise.t.test(soccer_general$Height, soccer_general$Position, pool.sd = FALSE, p.adjust.method = 'BH')

comparison_data_none <- data.frame(
  Position1 = c("Forward", "Goalkeeper", "Goalkeeper", "Midfielder"),
  Position2 = c("Defender", "Forward", "Midfielder", "Forward"),
  P_Value = c(t_res_wrk_none$p.value[2, 1], t_res_wrk_none$p.value[3, 1], t_res_wrk_none$p.value[3, 2], t_res_wrk_none$p.value[3, 3])
)

comparison_data_holm <- data.frame(
  Position1 = c("Forward", "Goalkeeper", "Goalkeeper", "Midfielder"),
  Position2 = c("Defender", "Forward", "Midfielder", "Forward"),
  P_Value = c(t_res_wrk_holm$p.value[2, 1], t_res_wrk_holm$p.value[3, 1], t_res_wrk_holm$p.value[3, 2], t_res_wrk_holm$p.value[3, 3])
)

comparison_data_BH <- data.frame(
  Position1 = c("Forward", "Goalkeeper", "Goalkeeper", "Midfielder"),
  Position2 = c("Defender", "Forward", "Midfielder", "Forward"),
  P_Value = c(t_res_wrk_BH$p.value[2, 1], t_res_wrk_BH$p.value[3, 1], t_res_wrk_BH$p.value[3, 2], t_res_wrk_BH$p.value[3, 3])
)

# Построение графика для comparison_data_none
plot_none <- ggplot(comparison_data_none, aes(x = Position1, y = Position2, fill = P_Value)) +
  geom_tile() +
  geom_text(aes(label = sprintf("%.4f", P_Value)), vjust = 1) +
  scale_fill_gradient(low = "green", high = "red") +
  labs(title = "None Adjustment",
       x = "Position 1",
       y = "Position 2",
       fill = "P Value") +
  theme_minimal()

# Построение графика для comparison_data_holm
plot_holm <- ggplot(comparison_data_holm, aes(x = Position1, y = Position2, fill = P_Value)) +
  geom_tile() +
  geom_text(aes(label = sprintf("%.4f", P_Value)), vjust = 1) +
  scale_fill_gradient(low = "green", high = "red") +
  labs(title = "Holm Adjustment",
       x = "Position 1",
       y = "Position 2",
       fill = "P Value") +
  theme_minimal()

# Построение графика для comparison_data_BH
plot_BH <- ggplot(comparison_data_BH, aes(x = Position1, y = Position2, fill = P_Value)) +
  geom_tile() +
  geom_text(aes(label = sprintf("%.4f", P_Value)), vjust = 1) +
  scale_fill_gradient(low = "green", high = "red") +
  labs(title = "Benjamini-Hochberg Adjustment",
       x = "Position 1",
       y = "Position 2",
       fill = "P Value") +
  theme_minimal()

# Объединение графиков
ggarrange(plot_none, plot_holm, plot_BH, nrow = 3)
```

Видно, что pairwise.t.test работает стабильно и для выборки и для генеральных данных.


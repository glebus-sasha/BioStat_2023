---
title: "Task 5"
author: "Oleg Arnaut"
date: "2023-11-26"
output: html_document
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(dplyr)

```

# Инструкции

Ниже приведены семь клинических гипотез. В качестве задания протестируйте их, используя соответствующие статистические критерии. Решение должно содержать все элементы алгоритма проверки статистических гипотез:

• Сформулируете нулевую и альтернативную гипотезы.
• Укажите уровень значимости α.
• Определите статистический тест (критерий) для проверки гипотезы. При необходимости аргументируйте выбор одностороннего теста. 
• Укажите критическое значение статистики (используйте распределения из материалов лекции).
• Определите наблюдаемое значение статистики.
• Оцените статистическую значимость (p-value и/или доверительный интервал).
• Оцените практическую значимость.


*Данные для анализа необходимо генерировать самостоятельно в соответствии с каждой представленной гипотезой. По возможности используйте пакет dplyr


# Гипотеза 1. Существует ассоциация между уровнем физической активности (бинарная переменная, физическая активность может быть 'высокой' и 'низкой') и частотой возникновения сердечно-сосудистых заболеваний у пациентов старше 50 лет. Попробуйте вариант с большими выборками (sample_size <- 100). Как изменится стратегия при малых выборках (sample_size <- 30) ? 

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки 
sample_size <- 100

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- rep(c(1, 0), each = sample_size/2)

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)
cardio <- rep(c(1, 0), times = c(0.4 * sample_size, 0.6 * sample_size))

data_long <- data.frame(activity, cardio)

```


```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 30

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- rep(c(1, 0), each = sample_size/2)

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)
cardio <- rep(c(1, 0), times = c(0.4 * sample_size, 0.6 * sample_size))

# Перемешиваем данные
data_short <- data_long <- data.frame(activity, cardio)
    
```


## Решение

* Сформулируем гипотезы:                                                                     

Нулевая гипотеза (H0): $p = 0.5$

Доля людей с сердечно-сосудистыми заболеванями среди людей с высокой активностью 50%

Альтернативная гипотеза (H1): $p<0.5$

Доля людей с сердечно-сосудистыми заболеванями среди людей с высокой активностью меньше 50%

* Уровень значимости (α):

Обычно принимается стандартный уровень значимости 0.05.                                           

* Статистический тест (критерий):

Мы будем использовать z-критерий для разности долей, односторонний, так как предполагаем, что активность помогает снизить риск сердечно-сосудистых заболеваний.

* Критическое значение статистики:      

```{r}
# Уровень значимости
alpha <- 0.05

# Критическое значение для левостороннего теста
critical_value <- qnorm(alpha)

# Вывод результата
print(critical_value)
```

```{r}
library(BSDA)

# Значение нулевой гипотезы (обычно 0.5 для двустороннего теста)
p0 <- 0.5

# Рассчет стандартного отклонения
stdev <- sqrt(p0*(1-p0))

# Выполнение z-теста
результат_z_теста <- BSDA::z.test(data_long, mu = p0, alternative = "less", sigma.x = stdev)

# Вывод результатов теста
print(результат_z_теста)

```
* Наблюдаемое значение статистики:

$z=-0.7746$

* Оценка статистической значимости:

Уровень значимости (p-value) равен 0.2193, что больше стандартного уровня значимости 0.05. Следовательно, мы не можем отвергнуть нулевую гипотезу.

При уменьшении размера выборки до 30, мы можем изменить стратегию и использовать точный критерий для доли. Односторонний.

* Критическое значение статистики:  
```{r}
# Количество попыток (размер выборки)
n <- nrow(data_short)

# Ожидаемая доля успешных исходов
ожидаемая_доля <- 0.5

# Уровень значимости
alpha <- 0.05

# Критическое значение для одностороннего теста влево
critical_value <- qbinom(alpha, n, ожидаемая_доля)

# Вывод результата
print(critical_value)
```


```{r}

# Количество успешных исходов (наблюдаемых)
наблюдаемые_успехи <- data_short %>% filter(cardio == 1) %>% nrow()

# Выполнение биномиального теста
результат_бином_теста <- binom.test(наблюдаемые_успехи, n, p = ожидаемая_доля, alternative = "less")

# Вывод результатов теста
print(результат_бином_теста)

```
* Наблюдаемое значение статистики:

$number of successes = 12$

* Оценка статистической значимости:

Уровень значимости (p-value) равен 0.1808, что больше стандартного уровня значимости 0.05. 

Следовательно, мы не можем отвергнуть нулевую гипотезу.

* Оценка статистической значимости:

Мощности тестов недостаточно для доказательства ассоциации между уровнем физической активности и частотой возникновения сердечно-сосудистых заболеваний у пациентов старше 50 лет.

# Гипотеза 2. Применение нового метода лечения для пациентов с артериальной гипертензией приведет к уменьшению среднего артериального давления по сравнению с пациентами, получающими стандартное лечение.


## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки (в каждой группе)
sample_size <- 80

# В популяции с экспериментальным методом лечения средний уровень систолического артериального давления меньше (130 vs 135 mm) 
# Генерация данных для группы с новым методом лечения 
group1 <- rnorm(sample_size, mean = 130, sd = 10)  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- rnorm(sample_size, mean = 135, sd = 10)  # контрольная группа

```

## Решение

* Сформулируем гипотезы:

Нулевая гипотеза (H0): $\mu\geq\mu_0$

Среднее систолическогое артериального давление у пациентов с новым методом лечения не меньше, чем у пациентов, получающих стандартное лечение. 

Альтернативная гипотеза (H1): $\mu<\mu_0$

Существует различие в средних уровнях систолического артериального давления между группами.

* Уровень значимости (α):

Обычно принимается стандартный уровень значимости 0.05.
* Статистический тест (критерий):

Мы будем использовать t-тест для независимых выборок, односторонний, потому что мы предполагаем, что применение нового метода лечения для пациентов с артериальной гипертензией приведет к уменьшению среднего артериального давления по сравнению с пациентами, получающими стандартное лечение. Предположим, что дисперсии равны (в противном случае целесообразно использовать тест Уэлча)

* Критическое значение статистики:

```{r}
# Уровень значимости
alpha <- 0.05

# Степени свободы
degrees_of_freedom <- 2 * sample_size - 2

# Критическое значение для одностороннего теста влево
critical_value_one_sided <- qt(alpha, df = degrees_of_freedom)

# Вывод результата
print(critical_value_one_sided)
```


```{r}
t_test_result <- t.test(group1, group2, paired = FALSE, alternative = "less", var.equal = TRUE)
t_test_result
```

* Наблюдаемое значение статистики:

$t=-2.3719$

* Оценка статистической значимости:

$p-value=0.009451$, что позволяет отвергнуть нулевую гипотезу. 
Доверительный интервал ( -Inf -1.134298) не включает 0, что подтверждает значимость различий.

* Оценка практической значимости:

Уменьшение артериального давления на $133.95-130.20=3.75$ единиц не имеет практического значения.

# Гипотеза 3. Внедрение программы реабилитации для пациентов с хронической болью в спине приведет к улучшению их физической активности (предположим что физическую активность можно оценить по шкале 0-100)

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки 
sample_size <- 30

# В популяции до реабилитации средний уровень физической активности меньше (50 vs 60) 
# Генерация данных до реабилитации
before <- rbinom(sample_size, size = sample_size, prob = 0.5)

# Генерация данных после реабилитации
after <- rbinom(sample_size, size = sample_size, prob = 0.6)

# Создание таблицы данных
data <- data.frame(before, after)

```

## Решение

* Сформулируем гипотезы:

Нулевая гипотеза (H0): $\mu\leq\mu_0$

Средний уровень физической активности у людей, прошедших реабилитацию не больше, чем у людей не прошедших реабилитацию.

Альтернативная гипотеза (H1): $\mu>\mu_0$

Средний уровень физической активности у людей, прошедших реабилитацию больше, чем у людей не прошедших реабилитацию.

* Уровень значимости (α): 

Обычно принимается стандартный уровень значимости 0.05.

* Статистический тест (критерий):

Мы будем использовать t-тест для зависимых выборок, так как измерения до и после являются зависимыми.
Дисперсии нам не известы.
Односторонный, исходя из альтернативной гипотезы.
                                                                                    
* Критическое значение статистики:                                                                                     


```{r}
# Уровень значимости (например, 0.05)
alpha <- 0.05

# Степени свободы
df <- sample_size - 1

# Критическое значение для правостороннего теста
critical_value <- qt(1 - alpha, df)

# Вывод результата
print(critical_value)
```


```{r}
# Расчет статистики и p-value
t_test_result <- t.test(data$after, data$before, paired = TRUE, alternative = "greater")
t_test_result
```
* Наблюдаемое значение статистики:

$t=2.2396$

* Оценка статистической значимости:

$p-value=0.01648$

Отвергаем нулевую гипотезу. Доверительный интервал От (0.4263359       Inf) не включает 0. 

Это интервал, который охватывает истинное различие средних значений с 95% вероятностью.

* Оценка практической значимости:                                                                      

Оценка среднего различия 1.7 единиц указывает навряд ли значимо с практической точки зрения.


# Гипотеза 4. Применение нового метода лечения для пациентов с инфарктом миокарда увеличит долю вернувшихся к нормальной физической активности 

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 200

# В популяции экспериментального лечения вероятность нормальной физической активности больше (0.7 vs 0.65)
# Генерация данных по статусу лечение (бинарная переменная, новый метод или стандарт) в фиксированном соотношении 1:1
treatment <- rep(c(1, 0), each = sample_size/2)

# Сгенерируем данные по физической активности после лечения
activity <- ifelse(treatment == 1, rbinom(sample_size / 2, size = 1, prob = 0.7), rbinom(sample_size / 2, size = 1, prob = 0.65))

# Создадим датафрейм
data <- data.frame(treatment, activity)
table(data) 
```

## Решение

* Сформулируем гипотезы:

Нулевая гипотеза (H0): $p\le0.5$

Доля людей среди прошедших новое лечение, вернувшихся к нормальной физической активности не больше чем среди людей, прошедших референсную терапию.

Альтернативная гипотеза (H1): $p>0.5$

Доля людей среди прошедших новое лечение, вернувшихся к нормальной физической активности больше чем среди людей, прошедших референсную терапию.

Уровень значимости (α):

Обычно принимается стандартный уровень значимости 0.05.

* Статистический тест (критерий):

Мы будем использовать z-тест для разности долей, правосторонний, исходя из альтернативной гипотезы.

* Критическое значение статистики:   

```{r}
# Критическое значение для правостороннего теста
critical_value_right <- qnorm(1 - alpha)

# Вывод результата
print(critical_value_right)
```


```{r}
library(BSDA)

# Значение нулевой гипотезы
p0 <- 0.65

# Рассчет стандартного отклонения
stdev <- sqrt(p0*(1-p0))

# Выполнение z-теста
результат_z_теста <- BSDA::z.test(data, mu = p0, alternative = "greater", sigma.x = stdev)

# Вывод результатов теста
print(результат_z_теста)

```
* Наблюдаемое значение статистики:

$z=-3.4593$

* Оценка статистической значимости:

$p-value=0.9997$ 

Не можем отклонить нулевую гипотезу.


# Гипотеза 5. Применение медитации в течение 8 недель повлияет на наличие стресса (есть/нет) у лиц с высоким уровнем тревожности.

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 50

# Генерация данных до медитации (бинарная переменная) в фиксированном соотношении 1:1
before <- rbinom(sample_size, 1, 0.4)

# Генерация данных после медитации (бинарная переменная). После медитации вероятность наличия стресса меньше (0.2 vs 0.4)
after <- rbinom(sample_size, 1, 0.2)

```

## Решение


* Сформулируем гипотезы:

Нулевая гипотеза (H0): $p=p_0$

Нет разницы в доле стресса до и после медитации.

Альтернативная гипотеза (H1): $p\ne p_0$

Существует разница в доле стресса до и после медитации.

* Уровень значимости (α):

Обычно принимается стандартный уровень значимости 0.05.

* Статистический тест (критерий):

Используем McNemar's test для связанных выборок.


```{r}
# Создание таблицы сопряженности
contingency_table <- table(before, after)

# Расчет статистики и p-value
mcnemar_test_result <- mcnemar.test(contingency_table)
mcnemar_test_result    
```
* Наблюдаемое значение статистики:

$McNemar's \chi^2=0.5772$

* Оценка статистической значимости:

$p-value=4.402e-05$

Отвергаем нулевую гипотезу.


# Гипотеза 6. Применение альтернативного метода лечения для пациентов с биполярным расстройством приведет к значимому изменению уровня симптомов депрессии по отношению к группе, прошедшей стандартное лечение (депрессию можно определить по шкале от 0 до 100, при этом исследователь должен избежать любых предположений (кроме i.i.d.)).

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки для каждой группы
sample_size <- 20

# В популяции c экспериментальным методом лечения средний депрессии меньше (55 vs 68) 
# Генерация данных для экспериментальной группы 
group1 <- rnorm(sample_size, mean = 55, sd = 10)  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- rnorm(sample_size, mean = 68, sd = 10)  # контрольная группа

```

## Решение

* Сформулируем гипотезы:

Нулевая гипотеза (H0): $p(A>\mu)\ge P(A<\mu))$

Вероятность того, что изменение уровня симптомов депрессии после применения альтернативного метода лечения больше среднего уровня изменений при стандартном лечении, не меньше вероятности того, что изменение уровня симптомов депрессии после применения альтернативного метода лечения меньше среднего уровня изменений при стандартном лечении.

Альтернативная гипотеза (H1): $p(A>\mu)<P(A<\mu))$

Вероятность того, что изменение уровня симптомов депрессии после применения альтернативного метода лечения меньше вероятности изменения при стандартном лечении.

* Уровень значимости (α):

Обычно принимается стандартный уровень значимости 0.05.

* Статистический тест (критерий):

Будем использовать Манна-Уитни, левосторонний, исходя из наших гипотез

* Критическое значение статистики:  


```{r}

result <- wilcox.test(group1, group2, alternative = "less")
result

```
* Наблюдаемое значение статистики:

$W=129$

* Оценка статистической значимости:

$p-value=0.02794$

Отвергаем нулевую гипотезу.

# Гипотеза 7. Длительность сна (в часах) ассоциирована с уровенем стресса у студентов (шкала с нормальным распределением)

## Генерация данных  

```{r}

library(mvtnorm) # библиотека mvtnorm для работы с многомерным нормальным распределением

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 100

# Средние значения для длительности сна (HoursOfSleep) и уровня стресса (StressLevel) в популяции
means <- c(7, 5)  

# Матрица ковариации. В ислледуемой популяции HoursOfSleep и StressLevel ассоциированы отрицательно (r = -0.5)
cov_matrix <- matrix(c(1, -0.5, -0.5, 1), nrow = 2)

# Генерация данных из многомерного нормального распределения
df <- rmvnorm(n = sample_size, 
              mean = means, 
              sigma = cov_matrix) %>% 
      as_tibble() %>%
      setNames(c("HoursOfSleep", "StressLevel"))  

```
## Решение (дополните решение визуализацией)

* Сформулируем гипотезы:

Нулевая гипотеза (H0): Нет корреляции между длительностью сна и уровнем стресса у студентов.
Альтернативная гипотеза (H1): Существует отличающаяся от нуля корреляция между длительностью сна и уровнем стресса у студентов.

* Уровень значимости (α):

Обычно принимается стандартный уровень значимости 0.05.

* Статистический тест (критерий):

Используется тест корреляции Пирсона (Pearson's product-moment correlation).

* Критическое значение статистики: 

```{r}
# Уровень значимости
alpha <- 0.05

# Степени свободы
degrees_of_freedom <- sample_size - 1

# Критическое значение для одностороннего теста влево
critical_value <- qt(alpha, df = degrees_of_freedom)

# Вывод результата
print(critical_value)
```


```{r}
# Расчет статистики и p-value
cor_test_result <- cor.test(df$HoursOfSleep, df$StressLevel, method = "pearson")
cor_test_result              
```
* Наблюдаемое значение статистики:

$t=-6.0621$

* Оценка статистической значимости:

$p-value=2.511e-08$
Отвергаем нулевую гипотезу.


```{r}
# Подключение библиотек для визуализации
library(ggplot2)

# График рассеяния и линия линейной регрессии с коэффициентом корреляции
combined_plot <- ggplot(df, aes(x = HoursOfSleep, y = StressLevel)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "График рассеяния и линия линейной регрессии с коэффициентом корреляции",
       x = "Длительность сна (в часах)",
       y = "Уровень стресса") +
  geom_text(aes(label = paste("Корреляция =", round(cor_test_result$estimate, 2))),
            x = 5, y = 6.5, color = "red", size = 4)

print(combined_plot)
```





